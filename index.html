<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebP Animation Editor</title>
    <style>
      :root {
        --color-background: #1a1a1a;
        --color-surface: #2a2a2e;
        --color-surface-light: #3c3c42;
        --color-primary: #FFFFFF;
        --color-text: #eaeaea;
        --color-border: #555;
        --color-button-grey: #777777;
        --panel-gap: 10px;
        --color-pan: rgba(88, 121, 166, 0.5);
        --color-zoom: rgba(166, 82, 110, 0.5);
        --color-rotate: rgba(166, 106, 84, 0.5);
        --color-opacity: rgba(122, 88, 166, 0.5);
        --color-delete: #674445;
      }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background-color: var(--color-background);
        color: var(--color-text);
        overflow: hidden;
      }
      * {
        box-sizing: border-box;
      }
      #app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        position: relative;
      }
      .top-section { display: flex; flex-grow: 1; gap: var(--panel-gap); padding: var(--panel-gap); height: 60%; }
      .bottom-section {
        height: 40%;
        padding: 0 var(--panel-gap) var(--panel-gap);
        display: flex;
        flex-direction: column;
      }
      .panel { background-color: var(--color-surface); border-radius: 8px; padding: 15px; overflow: auto; }
      .top-section > .panel:nth-child(1) { overflow: hidden; }
      .top-section > .panel:nth-child(3) { overflow: hidden; }
      .placeholder-text, .placeholder-timeline { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #888; font-style: italic; text-align: center; }
      .placeholder-text h2 { margin: 0 0 10px 0; color: #aaa; font-style: normal; }
      button, .button-like {
        background-color: var(--color-button-grey); color: white; border: none; padding: 10px 15px;
        border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s;
        width: 100%; margin-bottom: 10px; text-align: center; display: block;
      }
      button:hover, .button-like:hover { background-color: #666666; }
      button:disabled { background-color: #555; cursor: not-allowed; opacity: 0.7; }
      input, select {
        width: 100%; padding: 8px; background-color: var(--color-surface-light);
        border: 1px solid var(--color-border); color: var(--color-text);
        border-radius: 4px; margin-bottom: 10px;
      }
      .control-group { padding-top: 15px; border-top: 1px solid var(--color-border); }
      .control-group:first-child { border-top: none; padding-top: 0; }
      .control-group h3 { margin-top: 0; margin-bottom: 15px; font-size: 16px; text-align: left; }
      .help-text, label { font-size: 12px; color: #999; margin-bottom: 5px; display: block; }
      .export-buttons { display: flex; gap: 5px; }
      .export-buttons button { width: 100%; margin-bottom: 0; }
      .dimensions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .dimensions-grid div { display: flex; flex-direction: column; }
      .thumbnail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .thumbnail-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 5px;
        border: 1px solid transparent;
        border-radius: 5px;
        cursor: pointer;
        background-color: var(--color-surface-light);
        min-width: 0;
      }
      .thumbnail-item.selected { border-color: var(--color-button-grey); }
      .thumbnail-item.drag-over { border: 2px dashed var(--color-primary); }
      .thumbnail-image-container {
        width: 100%;
        aspect-ratio: 1 / 1;
        background-color: var(--color-background);
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .thumbnail-image-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        pointer-events: none;
      }
      .thumbnail-item span {
        font-size: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 100%;
        text-align: center;
      }
      .context-menu {
        position: fixed; background-color: #444; border: 1px solid var(--color-border);
        border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 1000; width: 150px;
      }
      .context-item { padding: 10px 15px; cursor: pointer; }
      .context-item:hover { background-color: #777777; }
      .safari-warning {
        position: absolute; top: 10px; left: 10px; right: 10px; background-color: #ffc107;
        color: #333; padding: 10px; border-radius: 5px; font-size: 14px; text-align: center; z-index: 10;
      }
      .live-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
      .timeline-container { display: flex; flex-direction: column; height: 100%; }
      .timeline-header {
        display: flex;
        align-items: stretch;
        gap: 15px;
        margin-bottom: 10px;
        padding: 10px;
        background-color: var(--color-surface);
        border-radius: 8px;
      }
      .timeline-header-thumb {
        height: 66px;
        width: 66px;
        flex-shrink: 0;
        padding: 6px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 12px;
        color: #999;
      }
      .timeline-header-thumb:empty::before {
          content: "Select Image Above";
      }
      .timeline-header-thumb img { width: 100%; height: 100%; object-fit: contain; }
      .timeline-controls-wrapper { flex-grow: 1; min-width: 0; }
      .timeline-controls, .edit-form {
        padding: 0;
        background-color: transparent;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .timeline-controls h4, .edit-form h4 { margin: 0 0 10px; }
      .timeline-controls .button-group {
        display: flex;
        gap: 10px;
      }
      .timeline-controls .button-group button {
        width: auto;
        flex-grow: 1;
        margin-bottom: 0;
      }
      .timeline-rows-wrapper {
        flex-grow: 1;
        position: relative;
        margin-top: 20px;
      }
      .timeline-row { position: relative; height: 33.33%; border-top: 1px solid var(--color-border); }
      .timeline-row:first-child { border-top: none; }
      .time-ruler {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 1;
      }
      .ruler-line { position: absolute; top: 0; bottom: 0; width: 1px; }
      .ruler-line.second { background-color: #333; }
      .ruler-line.tenth { background-color: #222; }
      .ruler-label {
          position: absolute;
          top: -15px;
          font-size: 10px;
          color: #999;
          transform: translateX(-50%);
      }
      .animation-block {
        position: absolute; height: calc(100% - 2px); top: 1px; border-radius: 4px; color: white;
        display: flex; align-items: center; justify-content: flex-start;
        font-size: 12px;
        cursor: pointer; overflow: hidden; white-space: nowrap; border: 1px solid rgba(255,255,255,0.3);
        z-index: 2;
        padding: 1px;
      }
      .block-thumbnail {
          height: 100%;
          aspect-ratio: 1 / 1;
          object-fit: cover;
          border-radius: 3px;
          margin-right: 5px;
          flex-shrink: 0;
      }
      .animation-block.selected { border-width: 2px; border-color: white; z-index: 10; }
      .animation-block.pan { background-color: var(--color-pan); }
      .animation-block.zoom { background-color: var(--color-zoom); }
      .animation-block.rotate { background-color: var(--color-rotate); }
      .animation-block.opacity { background-color: var(--color-opacity); }
      .drag-placeholder {
        position: absolute;
        border: 1px dashed var(--color-button-grey);
        border-radius: 4px;
        z-index: 5;
        pointer-events: none;
      }
      .edit-form .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px 15px; }
      .edit-form .form-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
      .edit-form .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; }
      .edit-form .delete-btn { background-color: var(--color-delete); width: auto; margin-bottom: 0; }
      .loop-toggle { font-size: 14px; display: flex; align-items: center; gap: 5px; color: var(--color-text); cursor: pointer;}
      .loop-toggle input { width: auto; margin-bottom: 0; }
      .error-message {
        position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
        background-color: var(--color-delete); color: white; padding: 10px 20px;
        border-radius: 5px; z-index: 100;
      }
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        z-index: 2000;
      }
    </style>
</head>
<body>
    <div id="app" v-scope="App()">
        <div id="app-container">
            <div id="top-section"></div>
            <div id="bottom-section"></div>
            <div v-if="isRendering" class="loading-overlay">Rendering...</div>
        </div>
    </div>

    <script src="https://unpkg.com/petite-vue"></script>
    <script>
      const { createApp } = PetiteVue;
      const BACKEND_URL = 'https://swa-exporter.up.railway.app';

      function App() {
        return {
          project: {
            projectWidth: 600,
            projectHeight: 600,
            images: [],
            selectedImageId: null,
          },
          selectedBlock: null,
          timelineDuration: 10,
          overlapError: false,
          isRendering: false,
          draggedItemId: null,
          draggedBlockInfo: null,
          dragOverItemId: null,
          contextMenu: { visible: false, x: 0, y: 0, targetId: null },
          livePreviewSvgUrl: '',
          dragPlaceholder: { visible: false, left: '0px', width: '0px', top: '0px', height: '0px' },

          get sortedImages() {
            return [...this.project.images].sort((a, b) => a.order - b.order);
          },
          get selectedImage() {
            if (!this.project.selectedImageId) return null;
            return this.project.images.find(img => img.id === this.project.selectedImageId);
          },
          get isSafari() {
            return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
          },
          get timelineMarks() {
            const seconds = [];
            const tenths = [];
            const numSeconds = Math.floor(this.timelineDuration);
            for (let i = 0; i <= this.timelineDuration * 10; i++) {
              if (i % 10 !== 0) tenths.push(i * 100 / (this.timelineDuration * 10));
            }
            for (let i = 0; i <= numSeconds; i++) {
              seconds.push({ pos: (i / this.timelineDuration) * 100, label: i });
            }
            return { seconds, tenths };
          },

          updatePreview() {
            if (this.previewDebounce) clearTimeout(this.previewDebounce);
            this.previewDebounce = setTimeout(() => {
              if (this.project.images.length === 0) {
                if (this.livePreviewSvgUrl) {
                  URL.revokeObjectURL(this.livePreviewSvgUrl);
                  this.livePreviewSvgUrl = '';
                }
                return;
              }
              const svgContent = this.getSvgString();
              const blob = new Blob([svgContent], { type: 'image/svg+xml' });
              if (this.livePreviewSvgUrl) URL.revokeObjectURL(this.livePreviewSvgUrl);
              this.livePreviewSvgUrl = URL.createObjectURL(blob);
            }, 50);
          },
          getSvgString() {
            const { projectWidth, projectHeight, images } = this.project;
            if (images.length === 0) return '';
            const imagesToRender = [...images].sort((a, b) => b.order - a.order);
            const canvasCenterX = projectWidth / 2;
            const canvasCenterY = projectHeight / 2;
            const imageElements = imagesToRender.map(image => {
              const animationElements = image.animationBlocks.map(block => {
                const repeatCount = block.loop ? 'indefinite' : '1';
                let animations = '';
                const blockStartTime = block.startTime;
                const blockDuration = block.duration;
                switch (block.type) {
                  case 'pan': {
                    const { direction, distance, autoReverse } = block.parameters;
                    const pans = { right: `${distance} 0`, left: `${-distance} 0`, up: `0 ${-distance}`, down: `0 ${distance}` };
                    const to = pans[direction];
                    animations += `<animateTransform attributeName="transform" type="translate" additive="sum" begin="${blockStartTime}s" dur="${blockDuration}s" repeatCount="${repeatCount}" ${autoReverse ? `values="0 0; ${to}; 0 0" keyTimes="0; 0.5; 1"` : `from="0 0" to="${to}"`} />`;
                    break;
                  }
                  case 'zoom': {
                    const { startScale, endScale, autoReverse, useCenter, zoomX, zoomY } = block.parameters;
                    const cx = useCenter ? canvasCenterX : zoomX;
                    const cy = useCenter ? canvasCenterY : zoomY;
                    const fromTx = cx * (1 - startScale);
                    const fromTy = cy * (1 - startScale);
                    const toTx = cx * (1 - endScale);
                    const toTy = cy * (1 - endScale);
                    animations += `<animateTransform attributeName="transform" type="scale" additive="sum" begin="${blockStartTime}s" dur="${blockDuration}s" repeatCount="${repeatCount}" ${autoReverse ? `values="${startScale}; ${endScale}; ${startScale}" keyTimes="0; 0.5; 1"` : `from="${startScale}" to="${endScale}"`} />`;
                    animations += `<animateTransform attributeName="transform" type="translate" additive="sum" begin="${blockStartTime}s" dur="${blockDuration}s" repeatCount="${repeatCount}" ${autoReverse ? `values="${fromTx} ${fromTy}; ${toTx} ${toTy}; ${fromTx} ${fromTy}" keyTimes="0; 0.5; 1"` : `from="${fromTx} ${fromTy}" to="${toTx} ${toTy}"`} />`;
                    break;
                  }
                  case 'rotate': {
                    const { degrees, autoReverse, useCenter, rotateX, rotateY } = block.parameters;
                    const cx = useCenter ? canvasCenterX : rotateX;
                    const cy = useCenter ? canvasCenterY : rotateY;
                    const from = `0 ${cx} ${cy}`;
                    const to = `${degrees} ${cx} ${cy}`;
                    animations += `<animateTransform attributeName="transform" type="rotate" additive="sum" begin="${blockStartTime}s" dur="${blockDuration}s" repeatCount="${repeatCount}" ${autoReverse ? `values="${from}; ${to}; ${from}" keyTimes="0; 0.5; 1"` : `from="${from}" to="${to}"`} />`;
                    break;
                  }
                  case 'opacity': {
                    const { startOpacity, endOpacity, autoReverse } = block.parameters;
                    animations += `<animate attributeName="opacity" fill="freeze" begin="${blockStartTime}s" dur="${blockDuration}s" repeatCount="${repeatCount}" ${autoReverse ? `values="${startOpacity}; ${endOpacity}; ${startOpacity}" keyTimes="0; 0.5; 1"` : `from="${startOpacity}" to="${endOpacity}"`} />`;
                    break;
                  }
                }
                return animations;
              }).join('');
              return `<g>${animationElements}<image href="${image.base64Data}" width="${projectWidth}" height="${projectHeight}" x="0" y="0" /></g>`;
            }).join('');
            return `<svg width="${projectWidth}" height="${projectHeight}" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><clipPath id="canvas-clip"><rect x="0" y="0" width="${projectWidth}" height="${projectHeight}" /></clipPath></defs><g clip-path="url(#canvas-clip)">${imageElements}</g></svg>`;
          },

          async mounted() {
            try {
              const [topResponse, bottomResponse] = await Promise.all([
                fetch('./top-panels.html'),
                fetch('./bottom-panels.html')
              ]);
              if (!topResponse.ok || !bottomResponse.ok) {
                throw new Error('Failed to load panel HTML');
              }
              const topHtml = await topResponse.text();
              const bottomHtml = await bottomResponse.text();
              document.getElementById('top-section').innerHTML = topHtml;
              document.getElementById('bottom-section').innerHTML = bottomHtml;
              // Initialize Petite-Vue for panels
              this.$nextTick(() => {
                createApp({}).mount('#top-section');
                createApp({}).mount('#bottom-section');
              });
            } catch (error) {
              console.error('Error loading panels:', error);
              alert('Failed to load UI components. Please refresh the page.');
            }
            this.updatePreview();
          }
        }
      }

      createApp(App()).mount('#app');
    </script>
</body>
</html>
