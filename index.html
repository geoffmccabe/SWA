<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebP Animation Editor</title>
    <style>
      :root {
        --color-background: #1a1a1a;
        --color-surface: #2a2a2e;
        --color-surface-light: #3c3c42;
        --color-button-grey: #777777;
        --color-primary: var(--color-button-grey);
        --color-text: #eaeaea;
        --color-border: #555;
        --panel-gap: 10px;
        --color-pan: rgba(88, 121, 166, 0.5);
        --color-zoom: rgba(166, 82, 110, 0.5);
        --color-rotate: rgba(166, 106, 84, 0.5);
        --color-opacity: rgba(122, 88, 166, 0.5);
        --color-delete: #674445;
      }
      body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--color-background); color: var(--color-text); overflow: hidden; }
      * { box-sizing: border-box; }
      #app-container { display: flex; flex-direction: column; height: 100vh; position: relative; }
      .top-section { display: flex; flex-grow: 1; gap: var(--panel-gap); padding: var(--panel-gap); height: 60%; }
      .bottom-section { height: 40%; padding: 10px var(--panel-gap) var(--panel-gap); display: flex; flex-direction: column; }
      .panel { background-color: var(--color-surface); border-radius: 8px; padding: 15px; overflow: auto; }
      .top-section > .panel:nth-child(1) { overflow: hidden; }
      .top-section > .panel:nth-child(3) { overflow: hidden; }
      .placeholder-text { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #888; font-style: italic; text-align: center; }
      .placeholder-text h2 { margin: 0 0 10px 0; color: #aaa; font-style: normal; }
      button, .button-like { background-color: var(--color-button-grey); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; width: 100%; margin-bottom: 10px; text-align: center; display: block; }
      button:hover, .button-like:hover { background-color: #666666; }
      button:disabled { background-color: #555; cursor: not-allowed; opacity: 0.7; }
      input, select { width: 100%; padding: 8px; background-color: var(--color-surface-light); border: 1px solid var(--color-border); color: var(--color-text); border-radius: 4px; margin-bottom: 10px; }
      .control-group { padding-top: 15px; border-top: 1px solid var(--color-border); }
      .control-group:first-child { border-top: none; padding-top: 0; }
      .control-group h3 { margin-top: 0; margin-bottom: 15px; font-size: 16px; text-align: left; }
      .help-text, label { font-size: 12px; color: #999; margin-bottom: 5px; display: block; }
      .export-buttons { display: flex; gap: 5px; }
      .export-buttons button { width: 100%; margin-bottom: 0; }
      .dimensions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .dimensions-grid div { display: flex; flex-direction: column; }
      .thumbnail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .thumbnail-item { display: flex; flex-direction: column; gap: 4px; padding: 5px; border: 1px solid transparent; border-radius: 5px; cursor: pointer; background-color: var(--color-surface-light); min-width: 0; }
      .thumbnail-item.selected { border-color: var(--color-button-grey); }
      .thumbnail-item.drag-over { border: 1px dashed var(--color-button-grey); }
      .thumbnail-image-container { width: 100%; aspect-ratio: 1 / 1; background-color: var(--color-background); border-radius: 3px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
      .thumbnail-image-container img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
      .thumbnail-item span { font-size: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; }
      .context-menu { position: fixed; background-color: #444; border: 1px solid var(--color-border); border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 1000; width: 150px; }
      .context-item { padding: 10px 15px; cursor: pointer; }
      .context-item:hover { background-color: #777777; }
      .safari-warning { position: absolute; top: 10px; left: 10px; right: 10px; background-color: #ffc107; color: #333; padding: 10px; border-radius: 5px; font-size: 14px; text-align: center; z-index: 10; }
      .live-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
      .timeline-container { display: flex; flex-direction: column; height: 100%; padding-top: 15px; }
      .timeline-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
      .timeline-header-thumb { height: 66px; width: 66px; flex-shrink: 0; padding: 6px; border: 1px solid var(--color-border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #888; text-align: center; }
      .timeline-header-thumb img { width: 100%; height: 100%; object-fit: contain; }
      .timeline-controls-wrapper { flex-grow: 1; min-width: 0; }
      .timeline-controls, .edit-form { padding: 10px; background-color: var(--color-surface); border-radius: 8px; }
      .timeline-controls h4, .edit-form h4 { margin: 0 0 10px; }
      .timeline-controls .button-group { display: flex; gap: 10px; }
      .timeline-controls .button-group button { width: auto; flex-grow: 1; margin-bottom: 0; }
      .timeline-rows-wrapper { flex-grow: 1; position: relative; }
      .timeline-row { position: relative; height: 33.33%; border-top: 1px solid var(--color-border); }
      .timeline-row:first-child { border-top: none; }
      .time-ruler { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
      .ruler-line { position: absolute; top: 0; bottom: 0; width: 1px; }
      .ruler-line.second { background-color: #333; }
      .ruler-line.tenth { background-color: #222; }
      .ruler-label { position: absolute; top: -15px; font-size: 10px; color: #999; transform: translateX(-50%); }
      .animation-block { position: absolute; height: calc(100% - 2px); top: 1px; border-radius: 4px; color: white; display: flex; align-items: center; justify-content: flex-start; font-size: 12px; cursor: pointer; overflow: hidden; white-space: nowrap; border: 1px solid rgba(255,255,255,0.3); z-index: 2; padding: 1px; }
      .block-thumbnail { height: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 3px; margin-right: 5px; flex-shrink: 0; }
      .animation-block.selected { border: 2px solid white; z-index: 10; }
      .drop-placeholder { position: absolute; height: calc(33.33% - 4px); margin-top: 2px; border: 1px dashed var(--color-button-grey); z-index: 5; border-radius: 4px; pointer-events: none; background-color: rgba(255,255,255,0.1); }
      .animation-block.pan { background-color: var(--color-pan); }
      .animation-block.zoom { background-color: var(--color-zoom); }
      .animation-block.rotate { background-color: var(--color-rotate); }
      .animation-block.opacity { background-color: var(--color-opacity); }
      .edit-form .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
      .edit-form .form-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
      .edit-form .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; }
      .edit-form .delete-btn { background-color: var(--color-delete); width: auto; margin-bottom: 0; }
      .loop-toggle { font-size: 14px; display: flex; align-items: center; gap: 5px; color: var(--color-text); cursor: pointer;}
      .loop-toggle input { width: auto; margin-bottom: 0; }
      .error-message { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background-color: var(--color-delete); color: white; padding: 10px 20px; border-radius: 5px; z-index: 100; }
      .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; z-index: 2000; }
    </style>
</head>
<body>
    <div id="app" v-scope="App()">
        <div id="app-container">
            <div class="top-section">
              <div class="panel">
                <div class="control-group">
                  <h3>Project</h3>
                  <button @click="saveProject">Save Project</button>
                  <label class="button-like">Load Project
                    <input type="file" @change="handleProjectLoad" accept=".json" style="display: none;">
                  </label>
                </div>
                <div class="control-group">
                  <h3>Export Animation:</h3>
                  <div class="export-buttons">
                    <button @click="exportSVG">SVG</button>
                    <button @click="exportVideo('mp4')" :disabled="isRendering">MP4</button>
                    <button disabled>WEBP</button>
                  </div>
                </div>
                <div class="control-group">
                  <h3>Images</h3>
                  <label class="button-like">Load Images
                    <input type="file" @change="handleImageUpload" multiple accept="image/webp,image/jpeg,image/png" style="display: none;">
                  </label>
                  <p class="help-text">Upload up to 10 WebP, JPG, or PNG files.</p>
                </div>
                <div class="control-group">
                  <h3>Dimensions</h3>
                  <div class="dimensions-grid">
                      <div>
                          <label>Width (px)</label>
                          <input type="number" v-model="project.projectWidth" @input="updatePreview">
                      </div>
                      <div>
                          <label>Height (px)</label>
                          <input type="number" v-model="project.projectHeight" @input="updatePreview">
                      </div>
                  </div>
                </div>
              </div>
              <div class="panel" style="min-width: 0;" @contextmenu.prevent>
                <div v-if="project.images.length > 0" class="thumbnail-grid">
                    <div
                      v-for="(image, index) in sortedImages"
                      :key="image.id"
                      class="thumbnail-item"
                      :class="{ selected: image.id === project.selectedImageId, 'drag-over': dragOverItemId === image.id }"
                      :draggable="true"
                      @click="selectImage(image.id)"
                      @contextmenu.prevent="openContextMenu($event, image.id)"
                      @dragstart="onImageDragStart(image.id)"
                      @dragover.prevent="onImageDragOver(image.id)"
                      @dragleave="onImageDragLeave"
                      @drop="onImageDrop(image.id)"
                    >
                      <div class="thumbnail-image-container">
                          <img :src="image.base64Data" alt="thumbnail">
                      </div>
                      <span>{{ index + 1 }} - {{ image.name }}</span>
                    </div>
                </div>
                <div v-else class="placeholder-text">
                    <p>Load Project<br>or<br>Images to begin</p>
                </div>
                <div v-if="contextMenu.visible" class="context-menu" :style="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }" @mouseleave="closeContextMenu">
                  <div class="context-item" @click="deleteImage(contextMenu.targetId)">Delete Image</div>
                </div>
              </div>
              <div class="panel" style="display: flex; align-items: center; justify-content: center;">
                 <div v-if="isSafari" class="safari-warning">Note: Live preview may not display correctly in Safari. Your export will still work.</div>
                 <template v-if="project.images.length > 0">
                    <object type="image/svg+xml" :data="livePreviewSvgUrl" class="live-preview"></object>
                 </template>
                 <div v-else class="placeholder-text">
                    <h2>Preview Panel</h2>
                    <p>Load Images to Activate</p>
                 </div>
              </div>
            </div>
            <div class="bottom-section">
              <div class="timeline-container">
                  <div class="timeline-header">
                      <div class="timeline-header-thumb">
                          <img v-if="selectedImage" :src="selectedImage.base64Data">
                          <span v-else>Select Image Above</span>
                      </div>
                      <div class="timeline-controls-wrapper">
                        <div v-if="selectedImage && selectedBlock" class="edit-form">
                            <h4>Edit {{ selectedBlock.type }} Animation</h4>
                            <div class="form-grid" @input="updatePreview">
                                <div><label>Start Time (s)</label><input type="number" v-model.number="selectedBlock.startTime" min="0" step="0.1"></div>
                                <div><label>Duration (s)</label><input type="number" v-model.number="selectedBlock.duration" min="0.1" step="0.1"></div>
                                <template v-if="selectedBlock.type === 'pan'">
                                    <div><label>Direction</label><select v-model="selectedBlock.parameters.direction"><option>left</option><option>right</option><option>up</option><option>down</option></select></div>
                                    <div><label>Distance (px)</label><input type="number" v-model="selectedBlock.parameters.distance"></div>
                                </template>
                                <template v-if="selectedBlock.type === 'zoom'">
                                    <div><label>Start Scale</label><input type="number" step="0.1" v-model="selectedBlock.parameters.startScale"></div>
                                    <div><label>End Scale</label><input type="number" step="0.1" v-model="selectedBlock.parameters.endScale"></div>
                                    <div><label>Center X (px)</label><input type="number" v-model.number="selectedBlock.parameters.centerX" :disabled="selectedBlock.parameters.useCenter"></div>
                                    <div><label>Center Y (px)</label><input type="number" v-model.number="selectedBlock.parameters.centerY" :disabled="selectedBlock.parameters.useCenter"></div>
                                </template>
                                <template v-if="selectedBlock.type === 'rotate'">
                                    <div><label>Degrees</label><input type="number" v-model.number="selectedBlock.parameters.degrees"></div>
                                    <div><label>Center X (px)</label><input type="number" v-model.number="selectedBlock.parameters.rotateX" :disabled="selectedBlock.parameters.useCenter"></div>
                                    <div><label>Center Y (px)</label><input type="number" v-model.number="selectedBlock.parameters.rotateY" :disabled="selectedBlock.parameters.useCenter"></div>
                                </template>
                                <template v-if="selectedBlock.type === 'opacity'">
                                    <div><label>Start Opacity</label><input type="number" step="0.1" min="0" max="1" v-model="selectedBlock.parameters.startOpacity"></div>
                                    <div><label>End Opacity</label><input type="number" step="0.1" min="0" max="1" v-model="selectedBlock.parameters.endOpacity"></div>
                                </template>
                            </div>
                             <div class="form-footer">
                                 <div class="checkbox-group" @change="updatePreview">
                                     <label class="loop-toggle"><input type="checkbox" v-model="selectedBlock.loop"> Loop</label>
                                     <template v-if="selectedBlock.parameters.hasOwnProperty('autoReverse')">
                                         <label class="loop-toggle"><input type="checkbox" v-model="selectedBlock.parameters.autoReverse"> Auto-Reverse</label>
                                     </template>
                                      <template v-if="selectedBlock.type === 'rotate' || selectedBlock.type === 'zoom'">
                                         <label class="loop-toggle"><input type="checkbox" v-model="selectedBlock.parameters.useCenter"> Use Center</label>
                                     </template>
                                 </div>
                                 <button class="delete-btn" @click="deleteAnimationBlock(selectedBlock.id)">Delete Block</button>
                             </div>
                        </div>
                        <div v-else class="timeline-controls">
                            <h4>Add Animation Block</h4>
                            <div class="button-group">
                              <button @click="addAnimationBlock('pan')" :disabled="!selectedImage">Pan</button>
                              <button @click="addAnimationBlock('zoom')" :disabled="!selectedImage">Zoom</button>
                              <button @click="addAnimationBlock('rotate')" :disabled="!selectedImage">Rotate</button>
                              <button @click="addAnimationBlock('opacity')" :disabled="!selectedImage">Opacity</button>
                            </div>
                        </div>
                      </div>
                  </div>
                  <div class="timeline-rows-wrapper" ref="timelineWrapper" @dragover.prevent="onBlockDragOver" @dragleave="onBlockDragLeave" @drop="onBlockDrop">
                      <div class="time-ruler">
                          <div v-for="mark in timelineMarks.tenths" :key="'tenth-' + mark" class="ruler-line tenth" :style="{ left: mark + '%' }"></div>
                          <div v-for="mark in timelineMarks.seconds" :key="'sec-' + mark.pos" class="ruler-line second" :style="{ left: mark.pos + '%' }"></div>
                          <div v-for="mark in timelineMarks.seconds" :key="'label-' + mark.pos" class="ruler-label" :style="{ left: mark.pos + '%' }">{{ mark.label }}s</div>
                      </div>
                      <div v-if="dropPlaceholder.visible" class="drop-placeholder" :style="dropPlaceholder.style"></div>
                      <div v-for="rowIndex in [0, 1, 2]" :key="rowIndex" class="timeline-row" :data-row-index="rowIndex">
                          <div
                              v-for="block in getBlocksForRow(rowIndex)"
                              :key="block.id"
                              class="animation-block"
                              :class="[block.type, { 'selected': selectedBlock && selectedBlock.id === block.id }]"
                              :style="{ left: `${(block.startTime / timelineDuration) * 100}%`, width: `${(block.duration / timelineDuration) * 100}%` }"
                              draggable="true"
                              @dragstart="onBlockDragStart($event, block)"
                              @click="selectBlock(block)"
                          >
                              <img v-if="selectedImage" :src="selectedImage.base64Data" class="block-thumbnail">
                              <span>{{ block.type }}</span>
                          </div>
                      </div>
                      <div v-if="overlapError" class="error-message">Cannot overlap more than 3 animations.</div>
                  </div>
              </div>
            </div>
            <div v-if="isRendering" class="loading-overlay">Rendering...</div>
        </div>
    </div>
</body>
